{% extends "base.html" %}
{% block title %}Chat with {{ chat_with.username }}{% endblock %}

{% block content %}
<h2>Chat with {{ chat_with.username }}</h2>

{% for msg in messages %}
  <div class="message-wrapper">
    <div class="message-bubble">
      <strong>{{ msg.sender.username }}</strong><br>
      {{ msg.message }}

      <!-- Meta info -->
      <div class="message-meta">
        {% if msg.sender_id == current_user.id %}
          <span class="read-status">{{ 'Read' if msg.read else 'Sent' }}</span>
        {% endif %}

        <!-- Reaction Button -->
        <button class="reaction-btn" onclick="reactToMessage('{{ msg.id }}')">üëç</button>

        {% if msg.sender_id == current_user.id %}
          <button class="delete-btn" data-id="{{ msg.id }}">üóë</button>
        {% endif %}
      </div>
    </div>
  </div>
{% endfor %}



<input type="text" id="message-input" placeholder="Type a message...">
<button id="send-button">Send</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    // Scroll to bottom helper
    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // On connect, you join the room (this part happens server-side with session)
    socket.on('connect', () => {
        console.log('Connected to server');
    });

    // Send message
    sendButton.addEventListener('click', () => {
        const message = messageInput.value.trim();
        if (message) {
            socket.emit('message', { data: message });
            messageInput.value = '';
        }
    });

    // Enter key to send
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendButton.click();
        }
    });

    // Receive new message
    socket.on('message', (data) => {
        console.log('New message:', data);
        const msgElement = document.createElement('p');
        msgElement.innerHTML = `<strong>${data.name}</strong>: ${data.message}`;
        messagesDiv.appendChild(msgElement);
        scrollToBottom();
    });

    
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('delete-btn')) {
            const messageId = e.target.getAttribute('data-id');

            fetch(`/delete-message/${messageId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                   
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const messageEl = document.querySelector(`p[data-id='${messageId}']`);
                    if (messageEl) messageEl.remove();
                }
            });
        }
    });


</script>


<style>
/* Container Styling */
#messages {
    height: 300px;
    overflow-y: auto;
    border: 1px solid #f15c22;
    border-radius: 8px;
    padding: 10px;
    background-color: #fbf3e2;
    box-shadow: 0 0 10px #f15c22(0, 0, 0, 0.05);
    margin-bottom: 15px;
}

/* Message Paragraphs */
#messages p {
    margin: 8px 0;
    line-height: 1.5;
    font-size: 15px;
}

/* Message Sender Name */
#messages p strong {
    color: #fbf3e2;
}

/* Input Field */
#message-input {
    width: 75%;
    padding: 10px;
    border: 1px solid #f15c22;
    background-color:#fbf3e2 ;
    border-radius: 6px;
    font-size: 14px;
    margin-right: 10px;
    outline: none;
}

/* Send Button */
#send-button {
    padding: 10px 16px;
    background-color: #173c67;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s;
}

#send-button:hover {
    background-color: #f15c22;
}

/* Chat Heading */
h2 {
    margin-bottom: 20px;
    color: #f15c22;
    font-size: 50px;
}

.message-wrapper {
    display: flex;
    margin-bottom: 12px;
}

.message-wrapper.sent {
    justify-content: flex-end;
}

.message-wrapper.received {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 65%;
    padding: 10px 14px;
    border-radius: 15px;
    background-color: #173c67;
    position: relative;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    word-wrap: break-word;
    color: #fbf3e2;
}

.message-wrapper.sent .message-bubble {
    background-color: #dcf8c6; /* Light green for sent messages */
    text-align: right;
}

.message-meta {
    margin-top: 6px;
    font-size: 0.8em;
    color: #666;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.reaction-btn, .delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    margin-left: 6px;
    font-size: 0.9em;
}

</style>
<script>
    document.addEventListener('click', function (event) {
        if (event.target.classList.contains('reaction-btn')) {
            const msgId = event.target.getAttribute('data-id');
            reactToMessage(msgId);
        }
    });

    function reactToMessage(msgId) {
        console.log('Reacting to message ID:', msgId);
       
    }
</script>



{% endblock %}