{% extends "base.html" %} 
<title>{% block title %}Post{% endblock %}</title>

{% block content %}

    <h1>Chat Room</h1>
    <div style="display: flex; gap: 2rem;">
        <div style="width: 25%; border-right: 1px solid #ccc; padding-right: 1rem;">
            <h3>Followers</h3>
            <ul id="followersList" style="list-style: none; padding: 0;">
                {% for follower in followers %}
                <li><button class="userBtn" data-username="{{ follower.username }}">{{ follower.username }}</button></li>
                {% else %}
                <li>No followers</li>
                {% endfor %}
            </ul>
            <h3>Following</h3>
            <ul id="followingList" style="list-style: none; padding: 0;">
                {% for follow in following %}
                <li><button class="userBtn" data-username="{{ follow.username }}">{{ follow.username }}</button></li>
                {% else %}
                <li>No following</li>
                {% endfor %}
            </ul>
        </div>
        <div style="width: 75%;">
            <div id="chatHeader"><strong>Chat with: </strong><span id="chatWith">Select a user</span></div>
            <div id="messages" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem;"></div>
            <input id="messageInput" autocomplete="off" style="width: 80%;" />
            <button id="sendBtn">Send</button>
        </div>
    </div>

    <script>
        const socket = io();

        const username = "{{ user.username }}";
        let currentChatUser = null;

        function joinRoom(room) {
            socket.emit('join', {username: username, room: room});
        }

        function leaveRoom(room) {
            socket.emit('leave', {username: username, room: room});
        }

        function getRoomName(user1, user2) {
            return [user1, user2].sort().join('_');
        }

        document.querySelectorAll('.userBtn').forEach(button => {
            button.addEventListener('click', () => {
                const selectedUser = button.getAttribute('data-username');
                if (currentChatUser) {
                    leaveRoom(getRoomName(username, currentChatUser));
                }
                currentChatUser = selectedUser;
                document.getElementById('chatWith').textContent = currentChatUser;
                const room = getRoomName(username, currentChatUser);
                joinRoom(room);
                document.getElementById('messages').innerHTML = '';
                socket.emit('fetch_messages', {room: room});
            });
        });

        socket.on('message', function(data) {
            const messages = document.getElementById('messages');
            let messageText = '';
            if (typeof data === 'string') {
                messageText = data;
            } else {
                messageText = data.username + ': ' + data.message;
            }
            const p = document.createElement('p');
            p.textContent = messageText;
            messages.appendChild(p);
            messages.scrollTop = messages.scrollHeight;
        });

        document.getElementById('sendBtn').onclick = function() {
            const input = document.getElementById('messageInput');
            const message = input.value;
            if (message && currentChatUser) {
                const room = getRoomName(username, currentChatUser);
                socket.emit('message', {username: username, room: room, message: message});
                input.value = '';
            }
        };

        window.onbeforeunload = function() {
            if (currentChatUser) {
                leaveRoom(getRoomName(username, currentChatUser));
            }
        };
    </script>

{% endblock %}